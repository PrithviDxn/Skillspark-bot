<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>SkillSpark Bot</title>
  <style>
    body { background: #222; color: #fff; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; }
    #avatar { width: 320px; height: 240px; background: #2C3E50; border-radius: 16px; display: flex; align-items: center; justify-content: center; position: relative; }
    #face { width: 120px; height: 120px; background: #ECF0F1; border-radius: 50%; position: relative; }
    .eye { width: 16px; height: 16px; background: #2C3E50; border-radius: 50%; position: absolute; top: 40px; }
    .eye.left { left: 28px; }
    .eye.right { right: 28px; }
    #mouth { width: 48px; height: 12px; background: #2C3E50; border-radius: 0 0 24px 24px; position: absolute; bottom: 24px; left: 50%; transform: translateX(-50%); }
    #question { position: absolute; bottom: 8px; left: 50%; transform: translateX(-50%); color: #ECF0F1; font-size: 18px; background: rgba(0,0,0,0.5); padding: 4px 12px; border-radius: 8px; }
  </style>
</head>
<body>
  <div id="avatar">
    <div id="face">
      <div class="eye left"></div>
      <div class="eye right"></div>
      <div id="mouth"></div>
    </div>
    <div id="question"></div>
  </div>
  <script src="https://media.twiliocdn.com/sdk/js/video/releases/2.28.1/twilio-video.min.js"></script>
  <script>
    // Parse query params
    function getQueryParam(name) {
      const url = new URL(window.location.href);
      return url.searchParams.get(name);
    }
    const token = getQueryParam('token');
    const roomName = getQueryParam('roomName');
    const question = getQueryParam('question') || 'Welcome to SkillSpark!';

    document.getElementById('question').textContent = question;

    // TTS: Speak the question
    function speak(text) {
      return new Promise((resolve) => {
        const utter = new window.SpeechSynthesisUtterance(text);
        utter.onend = resolve;
        window.speechSynthesis.speak(utter);
      });
    }

    // Create video track from avatar
    async function createAvatarVideoTrack() {
      const avatar = document.getElementById('avatar');
      const stream = avatar.captureStream(15);
      const [videoTrack] = stream.getVideoTracks();
      return Twilio.Video.createLocalVideoTrack({
        name: 'bot-avatar',
        video: { width: 320, height: 240, frameRate: 15 },
        mediaStreamTrack: videoTrack
      });
    }

    // Create audio track from TTS
    async function createTTSStream(text) {
      // Use the Web Audio API to capture TTS output
      const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      const dest = audioCtx.createMediaStreamDestination();
      const synth = window.speechSynthesis;
      const utter = new window.SpeechSynthesisUtterance(text);
      utter.onstart = () => {
        // Connect TTS to audioCtx
        const source = audioCtx.createMediaStreamSource(dest.stream);
        source.connect(audioCtx.destination);
      };
      synth.speak(utter);
      return dest.stream.getAudioTracks()[0];
    }

    async function joinRoom() {
      try {
        const videoTrack = await createAvatarVideoTrack();
        // For MVP, use microphone for audio (TTS capture is tricky cross-browser)
        let audioTrack;
        try {
          const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
          audioTrack = stream.getAudioTracks()[0];
        } catch (e) {
          audioTrack = null;
        }
        const tracks = [videoTrack];
        if (audioTrack) {
          tracks.push(await Twilio.Video.createLocalAudioTrack({ mediaStreamTrack: audioTrack }));
        }
        const room = await Twilio.Video.connect(token, {
          name: roomName,
          tracks,
          identity: 'bot',
        });
        // Speak the question after joining
        await speak(question);
        // Optionally: Listen for new questions via WebSocket or polling
      } catch (err) {
        document.getElementById('question').textContent = 'Bot failed to join: ' + err.message;
        console.error('Bot error:', err);
      }
    }
    if (token && roomName) joinRoom();
  </script>
</body>
</html> 